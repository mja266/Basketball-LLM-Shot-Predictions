<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üèÄ NBA Shot Predictor</title>
  <style>
    body {
      background-color: #111;
      color: #f7c600;
      font-family: 'Segoe UI', sans-serif;
      margin: 2rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }
    h1 { grid-column: 1 / -1; text-align: center; }
    .panel { background:#181818; border-radius:14px; padding:16px; }
    select, input {
      width: 100%;
      padding: 10px; margin: 8px 0;
      border-radius: 8px; border: none;
      background: #222; color: #fff; font-size: 1rem;
    }
    button {
      background-color: #f7c600; color: #000; font-weight: 700;
      border: none; border-radius: 8px; padding: 10px 20px; cursor: pointer;
    }
    button:hover { background-color: #ffdb4d; }
    .result { margin-top: 10px; font-size: 1.05rem; }
    .legend { display:flex; align-items:center; gap:10px; margin-top:10px; color:#ddd; font-size:.9rem; }
    .bar { height: 10px; flex:1; background: linear-gradient(90deg, #b21c1c, #e0e000, #1ec41e); border-radius:6px; }
    canvas { width: 100%; height: auto; background:#0e0e0e; border-radius:14px; cursor: crosshair; }
    .note { color:#aaa; font-size:.85rem; margin-top:8px; }
  </style>
</head>
<body>
  <h1>üèÄ NBA Shot Predictor</h1>

  <div class="panel">
    <label>Team</label>
    <select id="team"></select>
    <label>Player</label>
    <select id="player"></select>
    <label>Period (1‚Äì4)</label>
    <input id="period" type="number" min="1" max="4" value="4"/>
    <label>Time remaining (mm:ss)</label>
    <input id="time" type="text" value="2:00"/>
    <label>Shot type</label>
    <select id="shot">
      <option>2PT Field Goal</option>
      <option>3PT</option>
      <option>MID</option>
    </select>
    <label>X coordinate (0‚Äì50)</label>
    <input id="x" type="number" value="25" step="1"/>
    <label>Y coordinate (0‚Äì50)</label>
    <input id="y" type="number" value="25" step="1"/>
    <button id="predictBtn">Predict</button>
    <div id="result" class="result"></div>
    <div class="legend">
      <span>Lower</span><div class="bar"></div><span>Higher</span>
    </div>
    <div class="note">Click on the court to set shot location. Court shows red (missed) or green (made).</div>
  </div>

  <div class="panel">
    <canvas id="court" width="600" height="500"></canvas>
  </div>

  <script>
    const backendURL = "https://nba-shot-predictor.onrender.com";
    const canvas = document.getElementById('court');
    const ctx = canvas.getContext('2d');
    let teams = {};
    const els = {
      team: document.getElementById('team'),
      player: document.getElementById('player'),
      period: document.getElementById('period'),
      time: document.getElementById('time'),
      shot: document.getElementById('shot'),
      x: document.getElementById('x'),
      y: document.getElementById('y'),
      result: document.getElementById('result'),
      predictBtn: document.getElementById('predictBtn')
    };

    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
    const toPX = v => (v/50)*canvas.width;

    // üèÄ Draw realistic basketball half-court
    function drawCourtBase() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle="#0e0e0e";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.strokeStyle="#444";
      ctx.lineWidth=2;

      // Baseline
      ctx.beginPath();
      ctx.moveTo(toPX(0), toPX(0));
      ctx.lineTo(toPX(50), toPX(0));
      ctx.stroke();

      // Sidelines
      ctx.beginPath();
      ctx.moveTo(toPX(0), toPX(0));
      ctx.lineTo(toPX(0), toPX(47));
      ctx.moveTo(toPX(50), toPX(0));
      ctx.lineTo(toPX(50), toPX(47));
      ctx.stroke();

      // Free throw lane ("paint")
      ctx.beginPath();
      ctx.rect(toPX(17), toPX(0), toPX(16), toPX(19));
      ctx.stroke();

      // Free throw circle
      ctx.beginPath();
      ctx.arc(toPX(25), toPX(19), toPX(6), 0, Math.PI, true);
      ctx.stroke();

      // 3-point arc
      ctx.beginPath();
      ctx.arc(toPX(25), toPX(5.25), toPX(23.75), Math.PI*0.11, Math.PI*0.89, false);
      ctx.stroke();

      // Rim
      ctx.beginPath();
      ctx.arc(toPX(25), toPX(4.5), toPX(1.25), 0, Math.PI*2);
      ctx.stroke();

      // Backboard
      ctx.beginPath();
      ctx.moveTo(toPX(22), toPX(3.5));
      ctx.lineTo(toPX(28), toPX(3.5));
      ctx.stroke();

      // Center court (optional)
      ctx.beginPath();
      ctx.arc(toPX(25), toPX(47), toPX(3), 0, Math.PI*2);
      ctx.stroke();

      // Gradient legend (Low/High)
      const grad = ctx.createLinearGradient(20,20,120,20);
      grad.addColorStop(0,"#b21c1c");
      grad.addColorStop(0.5,"#e0e000");
      grad.addColorStop(1,"#1ec41e");
      ctx.fillStyle=grad;
      ctx.fillRect(20,20,100,10);
      ctx.fillStyle="#ccc";
      ctx.font="12px Segoe UI";
      ctx.fillText("Low",20,45);
      ctx.fillText("High",95,45);
    }

    function drawShotMarker(x,y, made) {
      const color = made ? "#00e676" : "#ff3b3b";
      ctx.fillStyle=color;
      ctx.strokeStyle="#000";
      ctx.lineWidth=2;
      ctx.beginPath();
      ctx.arc(toPX(x), canvas.height - toPX(y), 6, 0, Math.PI*2);
      ctx.fill();
      ctx.stroke();
    }

    async function fetchTeams(){ const r=await fetch(`${backendURL}/teams`); return r.json(); }

    async function loadTeams(){
      const d=await fetchTeams();
      if(!d.ok){els.result.innerText="‚ö†Ô∏è Failed to load teams.";return;}
      teams=d.teams; els.team.innerHTML="";
      Object.keys(teams).sort().forEach(t=>{
        const opt=document.createElement("option");
        opt.value=t; opt.textContent=t;
        els.team.appendChild(opt);
      });
      const fillPlayers=()=>{
        const sel=els.team.value;
        els.player.innerHTML="";
        (teams[sel]||[]).forEach(p=>{
          const o=document.createElement("option");
          o.value=p; o.textContent=p;
          els.player.appendChild(o);
        });
      };
      els.team.addEventListener("change",()=>{fillPlayers();});
      fillPlayers();
    }

    async function predict() {
      const payload = {
        team_id: els.team.value,
        player_name: els.player.value,
        period: els.period.value,
        pctimestring: els.time.value,
        shot_type: els.shot.value,
        x: els.x.value,
        y: els.y.value
      };

      const r = await fetch(`${backendURL}/predict`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      });
      const d = await r.json();
      if(!d.ok){els.result.innerHTML=`<span style="color:red;">‚ùå ${d.error}</span>`;return;}
      const color=d.prediction_label==="MADE"?"lime":"red";
      const pct=(d.made_probability*100).toFixed(1);
      els.result.innerHTML=`<span style="color:${color};">${d.player} ${d.prediction_label} (${pct}% chance)</span>`;
      drawCourtBase();
      drawShotMarker(payload.x, payload.y, d.prediction_label==="MADE");
    }

    els.predictBtn.addEventListener("click", predict);

    // üÜï Click-to-shoot feature
    canvas.addEventListener("click", async e=>{
      const rect = canvas.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / canvas.width) * 50;
      const y = ((canvas.height - (e.clientY - rect.top)) / canvas.height) * 50;
      els.x.value = x.toFixed(1);
      els.y.value = y.toFixed(1);
      await predict();
    });

    drawCourtBase();
    loadTeams();
  </script>
</body>
</html>
